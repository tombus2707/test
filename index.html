
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>8â€‘Bit Adventurer Forge</title>
<style>
body { background: #87ceeb; font-family: sans-serif; text-align: center; }
#portrait { width: 128px; height: 128px; image-rendering: pixelated; }
.toggle { margin: 10px; }
</style>
</head>
<body>
<h1>ðŸŽ² 8â€‘Bit Adventurer Forge</h1>
<div>
<label class="toggle">
<input type="checkbox" id="usePortraits" checked> Use Online Portraits
</label>
</div>
<button id="roll">Roll New Adventurer</button>
<div id="output"></div>
<script>
async function generateLocalAvatar() {
  // Simple pixel avatar generator (placeholder)
  const canvas = document.createElement('canvas');
  canvas.width = 32; canvas.height = 32;
  const ctx = canvas.getContext('2d');
  for (let y = 0; y < 32; y++) {
    for (let x = 0; x < 32; x++) {
      ctx.fillStyle = `hsl(${Math.random()*360},50%,${30+Math.random()*40}%)`;
      ctx.fillRect(x, y, 1, 1);
    }
  }
  const upCanvas = document.createElement('canvas');
  upCanvas.width = 128; upCanvas.height = 128;
  const upCtx = upCanvas.getContext('2d');
  upCtx.imageSmoothingEnabled = false;
  upCtx.drawImage(canvas, 0, 0, 128, 128);
  return upCanvas.toDataURL();
}

document.getElementById('roll').addEventListener('click', async () => {
  const useOnline = document.getElementById('usePortraits').checked;
  let portraitUrl = null;
  let errorMsg = null;
  if (useOnline) {
    try {
      const resp = await fetch('/.netlify/functions/portrait', { method: 'POST' });
      const data = await resp.json();
      if (data.error) {
        if (data.code === "billing_hard_limit_reached") {
          portraitUrl = await generateLocalAvatar();
          errorMsg = "Using fallback portrait (billing limit reached).";
        } else {
          errorMsg = data.error;
        }
      } else {
        portraitUrl = data.url;
      }
    } catch (e) {
      portraitUrl = await generateLocalAvatar();
      errorMsg = "Using fallback portrait (API unreachable).";
    }
  } else {
    portraitUrl = await generateLocalAvatar();
    errorMsg = "Using local portrait (online portraits off).";
  }

  const out = document.getElementById('output');
  out.innerHTML = "";
  if (portraitUrl) {
    const img = document.createElement('img');
    img.id = "portrait";
    img.src = portraitUrl;
    out.appendChild(img);
  }
  if (errorMsg) {
    const p = document.createElement('p');
    p.style.color = "red";
    p.textContent = errorMsg;
    out.appendChild(p);
  }
});
</script>
</body>
</html>
